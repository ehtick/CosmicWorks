# CosmicWorks - Azure Cosmos DB Data Modeling Demos

CosmicWorks is a .NET 8.0 console application demonstrating the evolution of data models from relational to NoSQL using Azure Cosmos DB. The application shows four progressive database schema versions (v1-v4) with interactive demos.

**ALWAYS reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.**

## Working Effectively

### Prerequisites and Setup
- Install .NET 8.0 SDK: `wget https://dotnet.microsoft.com/en-us/download/dotnet/8.0` or use your system package manager
- Install Azure CLI: `curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash`
- Install Azure Developer CLI (AZD): `curl -fsSL https://aka.ms/install-azd.sh | bash`

### Build and Test Commands
- **Bootstrap the repository**:
  ```bash
  cd /home/runner/work/CosmicWorks/CosmicWorks/src
  dotnet restore  # Takes ~1.5 seconds
  dotnet build    # Takes ~1.8 seconds
  ```
- **NEVER CANCEL**: Set timeout to 120+ seconds for restore and build commands. Build times are very fast and consistent.
- **No test projects exist** - `dotnet test` finds no test projects to run.

### Deployment Options (Choose One)

#### Option 1: Azure Developer CLI (AZD) - RECOMMENDED
```bash
# NEVER CANCEL: AZD deployment can take 10-15 minutes
# Set timeout to 20+ minutes for azd commands
azd auth login
azd init      # First time only
azd up        # Provisions Azure resources and creates appsettings.development.json
```

#### Option 2: Docker (Requires Azure deployment first)
```bash
# Deploy to Azure first (required for configuration)
azd auth login && azd init && azd up

# Build and run container - NEVER CANCEL: Takes 5-10 minutes
# Set timeout to 15+ minutes for docker build
docker-compose up --build
# OR manually:
docker build -t cosmicworks . --timeout=900
docker run -it --volume "./src/appsettings.development.json:/app/appsettings.development.json:ro" cosmicworks
```

#### Option 3: Local Development (Requires Azure deployment first)
```bash
# Deploy to Azure first (required for configuration)
azd auth login && azd init && azd up

# Run locally
cd src
dotnet run
```

### Running the Application
- **ALWAYS deploy to Azure first** using `azd up` to create the required `appsettings.development.json` file
- Run with: `cd src && dotnet run`
- Main menu options:
  - `a-j`: Various database operation demos
  - **`k`: Load sample data** - NEVER CANCEL: Can take 5-15 minutes on slow connections
  - `x`: Exit application

## Validation

### Manual Validation Requirements
After making any changes, ALWAYS run through this complete validation scenario:

1. **Build validation**:
   ```bash
   cd src
   dotnet clean && dotnet restore && dotnet build
   ```

2. **Application functionality validation**:
   ```bash
   # Ensure Azure resources are deployed first
   azd up  # If not already done
   
   # Run the application
   dotnet run
   
   # Test key menu options:
   # - Press 'a' to query for a single customer
   # - Press 'c' to list product categories  
   # - Press 'j' to get top 10 customers
   # - Press 'x' to exit
   ```

3. **Data loading validation** (if testing data operations):
   ```bash
   # In the running application menu:
   # - Press 'k' to load data from GitHub
   # NEVER CANCEL: This can take 5-15 minutes depending on connection speed
   # - Verify data loads successfully
   # - Test menu option 'a' again to verify data is available
   ```

### Build and Test Timing Expectations
- `dotnet restore`: ~1.5 seconds - NEVER CANCEL, set timeout to 120+ seconds
- `dotnet build`: ~1.8 seconds - NEVER CANCEL, set timeout to 60+ seconds  
- `azd up`: 10-15 minutes - NEVER CANCEL, set timeout to 20+ minutes
- Data loading (`k` option): 5-15 minutes - NEVER CANCEL, depends on network speed
- Docker build: 5-10 minutes - NEVER CANCEL, set timeout to 15+ minutes

## Key Projects and File Structure

### Primary Project
- **`src/CosmicWorks.csproj`**: Main .NET 8.0 console application
- **`src/Program.cs`**: Application entry point and interactive menu system
- **`src/Models.cs`**: Data models for different schema versions
- **`src/Dataload.cs`**: Data loading functionality from GitHub
- **`src/ChangeFeed.cs`**: Change feed processing for real-time monitoring

### Infrastructure
- **`infra/`**: Bicep templates for Azure resource deployment
- **`azure.yaml`**: Azure Developer CLI configuration
- **`Dockerfile`**: Container build configuration

### Data
- **`data/database-v1` through `data/database-v4`**: Sample data for different schema versions

## Common Tasks and Troubleshooting

### Essential Configuration
- **`appsettings.development.json`** is REQUIRED and auto-generated by `azd up`
- Contains Azure Cosmos DB endpoint configuration
- Uses Azure AD authentication (DefaultAzureCredential) - no connection strings needed

### Authentication Requirements
- Application uses Azure Managed Identity for Cosmos DB access
- AZD deployment automatically configures RBAC permissions
- Current user gets access permissions during deployment

### Docker Limitations
- Docker build may fail in network-restricted environments due to NuGet access
- Docker option requires Azure deployment first to generate configuration file
- Use local development option if Docker build fails

### Performance Notes
- Data loading can be slow on low bandwidth connections
- Application runs efficiently once data is loaded
- Each database operation shows request charge units (RUs) for cost analysis

## Repository Structure Reference
```
/home/runner/work/CosmicWorks/CosmicWorks/
├── src/                    # Main .NET application
├── infra/                  # Azure infrastructure templates
├── data/                   # Sample data for v1-v4 schemas
├── .devcontainer/          # Dev container configuration
├── azure.yaml              # AZD configuration
├── docker-compose.yml      # Docker composition
├── Dockerfile              # Container build
└── README.md               # Project documentation
```

## Common Error Resolution
- **"appsettings.development.json not found"**: Run `azd up` to deploy Azure resources
- **Authentication errors**: Ensure `azd auth login` was completed successfully  
- **Docker build failures**: Use local development option instead
- **Data loading timeouts**: Be patient, loading can take 15+ minutes on slow connections
- **Build failures**: Ensure .NET 8.0 SDK is installed and try `dotnet clean` first